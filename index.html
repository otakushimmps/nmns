<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>三四期空調系統汰換更新案設備查驗系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body class="min-h-screen pb-32 bg-slate-50">
  <header class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
      <div class="flex items-center gap-3 cursor-pointer" onclick="goHome()">
        <div class="bg-slate-900 text-white p-2 rounded-lg shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </div>
        <div>
          <h1 class="text-lg font-bold text-slate-800 tracking-tight">三四期空調系統汰換更新案設備查驗系統</h1>
          <div class="flex items-center gap-2">
            <span class="text-[10px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-mono">CMS.V2.2</span>
          </div>
        </div>
      </div>
      <div class="flex flex-col items-end">
        <div class="flex items-center gap-2 mb-1">
          <span class="text-xs font-bold text-slate-500">查驗進度</span>
          <span id="overall-percent" class="text-sm font-black text-blue-600">0%</span>
        </div>
        <div class="w-32 bg-slate-100 rounded-full h-1.5 overflow-hidden">
          <div id="global-progress" class="bg-blue-600 h-full rounded-full progress-bar" style="width: 0%"></div>
        </div>
        <div class="text-[11px] text-slate-400 mt-1">最後更新時間：<span id="last-updated">—</span></div>
      </div>
    </div>
  </header>
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="nav-header" class="hidden mb-6 flex justify-between items-center">
      <button onclick="closeDetail()"
        class="flex items-center gap-2 text-slate-500 hover:text-blue-600 transition font-medium text-sm group">
        <div
          class="bg-white border border-slate-200 p-1.5 rounded-full shadow-sm group-hover:border-blue-300 group-hover:shadow-md transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </div>
        <span>返回列表</span>
      </button>
    </div>
    <div id="tab-nav-container" class="border-b border-slate-200 mb-8 sticky top-[64px] z-40 bg-[#f8fafc] pt-2 pb-4">
    </div>
    <div id="main-display" class="min-h-[600px] animate-fade-in"></div>
  </main>
  <div
    class="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 p-4 z-50 shadow-lg flex flex-col md:flex-row justify-end items-center gap-4 md:gap-0">
    <div class="flex gap-3 w-full md:w-auto justify-end">
      <input type="file" id="import-progress-file" style="display:none" accept=".csv"
        onchange="importProgressCsv(this)">
      <button onclick="document.getElementById('import-progress-file').click()"
        class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-4 py-2 rounded-full shadow-sm text-sm font-bold flex items-center gap-2 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
        </svg>
        匯入進度
      </button>
      <button onclick="exportProgressCsv()"
        class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-4 py-2 rounded-full shadow-sm text-sm font-bold flex items-center gap-2 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        匯出進度
      </button>
    </div>
  </div>
  <script>
    const DATA_STORAGE_KEY = 'nmns_cms_records_v3_csv';
    const NOTES_STORAGE_KEY = 'nmns_cms_tab_notes_v1';
    const CSV_BASE_PATH = 'data';
    let appData = {};
    let tabOrder = [];
    let checkRecords = {};
    let equipmentNotes = {};
    let currentTab = 'summary';
    let currentDetailId = null;

    function ensureRecordStructure(itemId) {
      let record = checkRecords[itemId];
      if (!record) {
        record = { checks: [], parts: {}, checkMeta: {}, partMeta: {} };
        checkRecords[itemId] = record;
      } else if (Array.isArray(record)) {
        record = { checks: record, parts: {}, checkMeta: {}, partMeta: {} };
        checkRecords[itemId] = record;
      } else {
        record.checks = Array.isArray(record.checks) ? record.checks : [];
        record.parts = record.parts || {};
        record.checkMeta = record.checkMeta || {};
        record.partMeta = record.partMeta || {};
      }
      return record;
    }

    function normalizeStoredRecords() {
      Object.keys(checkRecords).forEach(key => ensureRecordStructure(key));
    }

    function normalizeEquipmentNotes() {
      const normalized = {};
      Object.keys(equipmentNotes || {}).forEach(key => {
        const entry = equipmentNotes[key];
        if (typeof entry === 'string') {
          normalized[key] = { text: entry, updatedAt: '' };
        } else if (entry && typeof entry === 'object') {
          normalized[key] = {
            text: entry.text || '',
            updatedAt: entry.updatedAt || ''
          };
        }
      });
      equipmentNotes = normalized;
    }

    function countSatisfiedParts(item, record) {
      if (!item.partsChecklist || !item.partsChecklist.length) return 0;
      let satisfied = 0;
      item.partsChecklist.forEach(part => {
        const expected = Number(part.expected);
        const actual = Number(record.parts[part.id] ?? record.parts[part.component] ?? '');
        if (!Number.isNaN(expected) && !Number.isNaN(actual) && expected === actual) satisfied++;
      });
      return satisfied;
    }

    function getItemProgress(item) {
      const record = ensureRecordStructure(item.id);
      const totalChecks = item.checkItems.length;
      const totalParts = item.partsChecklist ? item.partsChecklist.length : 0;
      const doneChecks = record.checks.length;
      const doneParts = countSatisfiedParts(item, record);
      return { total: totalChecks + totalParts, done: doneChecks + doneParts, record };
    }

    function ensureItemPartsIdentifiers(item) {
      if (!item || !item.partsChecklist) return;
      item.partsChecklist.forEach((part, index) => {
        if (!part.id) {
          part.id = part.component || `${item.id}-part-${String(index + 1).padStart(2, '0')}`;
        }
      });
    }

    function unescapeText(value) {
      if (!value) return '';
      let out = '';
      let escaped = false;
      for (let i = 0; i < value.length; i++) {
        const ch = value[i];
        if (escaped) {
          out += ch;
          escaped = false;
        } else if (ch === '\\') {
          escaped = true;
        } else {
          out += ch;
        }
      }
      if (escaped) out += '\\';
      return out;
    }

    function splitEscaped(text, delimiter) {
      if (!text) return [];
      const result = [];
      let current = '';
      let i = 0;
      while (i < text.length) {
        if (text[i] === '\\') {
          if (i + 1 < text.length) {
            current += text[i] + text[i + 1];
            i += 2;
            continue;
          }
        }
        if (text.startsWith(delimiter, i)) {
          result.push(unescapeText(current));
          current = '';
          i += delimiter.length;
          continue;
        }
        current += text[i];
        i++;
      }
      result.push(unescapeText(current));
      return result;
    }

    function splitEscapedOnce(text, delimiter) {
      if (!text) return { left: '', right: '', found: false };
      let current = '';
      let i = 0;
      while (i < text.length) {
        if (text[i] === '\\') {
          if (i + 1 < text.length) {
            current += text[i] + text[i + 1];
            i += 2;
            continue;
          }
        }
        if (text.startsWith(delimiter, i)) {
          return {
            left: unescapeText(current),
            right: unescapeText(text.slice(i + delimiter.length)),
            found: true
          };
        }
        current += text[i];
        i++;
      }
      return { left: unescapeText(text), right: '', found: false };
    }

    function normalizeCheckText(value) {
      const text = String(value || '');
      if (text.length >= 2 && text.startsWith('"') && text.endsWith('"')) {
        return text.slice(1, -1).replace(/""/g, '"');
      }
      return text;
    }

    function parseCsv(text) {
      const rows = [];
      let row = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (inQuotes) {
          if (char === '"') {
            if (text[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = false;
            }
          } else {
            current += char;
          }
        } else {
          if (char === '"') {
            inQuotes = true;
          } else if (char === ',') {
            row.push(current);
            current = '';
          } else if (char === '\n') {
            row.push(current);
            rows.push(row);
            row = [];
            current = '';
          } else if (char !== '\r') {
            current += char;
          }
        }
      }
      if (current.length || row.length) {
        row.push(current);
        rows.push(row);
      }
      return rows;
    }

    function csvToObjects(text) {
      const rows = parseCsv(text);
      if (!rows.length) return [];
      const headers = rows[0].map(header => header.replace(/^\ufeff/, '').trim());
      const result = [];
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.every(cell => String(cell).trim() === '')) continue;
        const obj = {};
        headers.forEach((header, index) => {
          obj[header] = row[index] ?? '';
        });
        result.push(obj);
      }
      return result;
    }

    function escapeCsvValue(value) {
      if (value === null || value === undefined) return '';
      const text = String(value);
      if (/[",\n\r]/.test(text)) {
        return `"${text.replace(/"/g, '""')}"`;
      }
      return text;
    }

    function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatIsoNow() {
      return new Date().toISOString();
    }

    function formatTimestamp(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return date.toLocaleString('zh-TW', { hour12: false });
    }

    function parseBooleanValue(value) {
      const normalized = String(value || '').trim().toLowerCase();
      return ['true', '1', 'yes', 'y', '是', '完成', '勾選'].includes(normalized);
    }

    function getRowValue(row, keys) {
      for (const key of keys) {
        if (key in row) return row[key];
      }
      return '';
    }

    async function loadCsvFile(filename) {
      const response = await fetch(`${CSV_BASE_PATH}/${filename}?v=${Date.now()}`);
      if (!response.ok) {
        throw new Error(`無法讀取 ${filename}`);
      }
      const text = await response.text();
      return csvToObjects(text);
    }

    async function loadCsvData() {
      const [tabs, equipment] = await Promise.all([
        loadCsvFile('tabs.csv'),
        loadCsvFile('equipment.csv')
      ]);
      const tabMap = {};
      const sortedTabs = tabs.slice().sort((a, b) => Number(a.order || 0) - Number(b.order || 0));
      tabOrder = [];
      sortedTabs.forEach(tab => {
        if (!tab.tabKey) return;
        tabMap[tab.tabKey] = {
          title: tab.title || tab.tabKey,
          desc: tab.desc || '',
          items: []
        };
        tabOrder.push(tab.tabKey);
      });
      equipment.forEach(row => {
        const tabKey = row.tabKey;
        if (!tabKey || !tabMap[tabKey]) return;
        const item = {
          id: (row.equipmentId || '').trim(),
          name: row.equipmentName || '',
          basicInfo: {},
          checkItems: [],
          partsChecklist: []
        };
        const basicEntries = splitEscaped(row.basicInfo || '', '|').filter(Boolean);
        basicEntries.forEach(entry => {
          const pair = splitEscapedOnce(entry, '=');
          if (pair.left) item.basicInfo[pair.left] = pair.right;
        });
        const checkEntries = splitEscaped(row.checks || '', '|')
          .map(entry => normalizeCheckText(entry))
          .filter(entry => entry !== '');
        item.checkItems = checkEntries;
        const partEntries = splitEscaped(row.parts || '', '|').filter(Boolean);
        partEntries.forEach((entry, index) => {
          let partId = '';
          let partBody = entry;
          const idSplit = splitEscapedOnce(entry, '::');
          if (idSplit.found) {
            partId = idSplit.left;
            partBody = idSplit.right;
          }
          const partSplit = splitEscapedOnce(partBody, ':');
          const component = partSplit.left;
          const expected = partSplit.right;
          const id = partId || component || `${item.id}-part-${String(index + 1).padStart(2, '0')}`;
          item.partsChecklist.push({ id, component, expected });
        });
        ensureItemPartsIdentifiers(item);
        tabMap[tabKey].items.push(item);
      });
      return tabMap;
    }

    async function init() {
      try {
        const stored = localStorage.getItem(DATA_STORAGE_KEY);
        if (stored) {
          checkRecords = JSON.parse(stored);
          normalizeStoredRecords();
        }
        const storedNotes = localStorage.getItem(NOTES_STORAGE_KEY);
        if (storedNotes) {
          equipmentNotes = JSON.parse(storedNotes);
          normalizeEquipmentNotes();
        }
        appData = await loadCsvData();
        renderTabNav();
        updateOverallProgress();
        render();
      } catch (error) {
        console.error(error);
        document.getElementById('main-display').innerHTML = '<div class="bg-white rounded-2xl border border-slate-200 p-6 text-slate-500">資料載入失敗，請確認 CSV 是否存在。</div>';
      }
    }

    function getItem(itemId) {
      for (const tabKey in appData) {
        const item = appData[tabKey].items.find(row => row.id === itemId);
        if (item) return item;
      }
      return null;
    }

    function getItemTabKey(itemId) {
      for (const tabKey in appData) {
        if (appData[tabKey].items.some(row => row.id === itemId)) return tabKey;
      }
      return '';
    }

    function exportProgressCsv() {
      const headers = ['設備ID', '類型', '項目ID', '查驗項目', '零件名稱', '是否完成', '現場點交', '最後更新時間', '備註'];
      const lines = [headers.join(',')];
      for (const tabKey in appData) {
        const tab = appData[tabKey];
        tab.items.forEach(item => {
          const record = ensureRecordStructure(item.id);
          item.checkItems.forEach((text, index) => {
            const checked = record.checks.includes(index) ? '是' : '否';
            const meta = record.checkMeta[index] || {};
            const row = [
              item.id,
              '查驗',
              String(index + 1),
              text,
              '',
              checked,
              '',
              meta.updatedAt || '',
              ''
            ];
            lines.push(row.map(escapeCsvValue).join(','));
          });
          const parts = item.partsChecklist || [];
          parts.forEach((part, index) => {
            const legacyIndexId = `${item.id}-part-${String(index + 1).padStart(2, '0')}`;
            const legacyDefaultId = `${item.id}-part-default`;
            const actualValue = record.parts[part.id]
              ?? record.parts[part.component]
              ?? record.parts[legacyIndexId]
              ?? record.parts[legacyDefaultId]
              ?? '';
            const expected = Number(part.expected);
            const actualNumber = Number(actualValue);
            const isDone = !Number.isNaN(expected) && !Number.isNaN(actualNumber) && expected === actualNumber;
            const meta = record.partMeta[part.id]
              || record.partMeta[part.component]
              || record.partMeta[legacyIndexId]
              || record.partMeta[legacyDefaultId]
              || {};
            const row = [
              item.id,
              '零件',
              part.id,
              '',
              part.component,
              isDone ? '是' : '否',
              actualValue,
              meta.updatedAt || '',
              ''
            ];
            lines.push(row.map(escapeCsvValue).join(','));
          });
          const noteEntry = equipmentNotes[item.id] || {};
          const noteRow = [
            item.id,
            '備註',
            '',
            '',
            '',
            '',
            '',
            noteEntry.updatedAt || '',
            noteEntry.text || ''
          ];
          lines.push(noteRow.map(escapeCsvValue).join(','));
        });
      }
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const linkElement = document.createElement('a');
      linkElement.href = URL.createObjectURL(blob);
      linkElement.setAttribute('download', `NMNS_Progress_${new Date().toISOString().slice(0, 10)}.csv`);
      document.body.appendChild(linkElement);
      linkElement.click();
      document.body.removeChild(linkElement);
      URL.revokeObjectURL(linkElement.href);
    }

    function importProgressCsv(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const rows = csvToObjects(event.target.result);
          if (!rows.length) {
            alert('匯入失敗：CSV 內容為空。');
            return;
          }
          applyProgressCsv(rows);
          saveRecords();
          alert('進度匯入成功！');
        } catch (err) {
          alert('匯入失敗：CSV 格式錯誤\n' + err);
        }
        input.value = '';
      };
      reader.readAsText(file);
    }

    function applyProgressCsv(rows) {
      checkRecords = {};
      equipmentNotes = {};
      rows.forEach(row => {
        const equipmentId = getRowValue(row, ['equipmentId', '設備ID']);
        if (!equipmentId) return;
        let recordType = String(getRowValue(row, ['recordType', '類型']) || '').toLowerCase();
        const updatedAt = getRowValue(row, ['updatedAt', '最後更新時間']) || '';
        const recordId = getRowValue(row, ['recordId', '項目ID']);
        const checkText = getRowValue(row, ['checkText', '查驗項目']);
        const component = getRowValue(row, ['component', '零件名稱']);
        const checkedValue = getRowValue(row, ['checked', '是否完成']);
        const actualValue = getRowValue(row, ['actual', '現場點交']);
        const noteText = getRowValue(row, ['note', '備註']);
        if (!recordType) {
          if (component) recordType = 'part';
          if (checkText) recordType = 'check';
          if (noteText) recordType = 'note';
        }
        if (recordType.includes('查驗')) recordType = 'check';
        if (recordType.includes('零件')) recordType = 'part';
        if (recordType.includes('備註')) recordType = 'note';
        if (recordType === 'check') {
          const record = ensureRecordStructure(equipmentId);
          const item = getItem(equipmentId);
          let index = Number(recordId) - 1;
          if (Number.isNaN(index) && item && checkText) {
            index = item.checkItems.findIndex(text => text === checkText);
          }
          if (index >= 0) {
            if (parseBooleanValue(checkedValue)) {
              if (!record.checks.includes(index)) record.checks.push(index);
            } else {
              record.checks = record.checks.filter(i => i !== index);
            }
            if (updatedAt) record.checkMeta[index] = { updatedAt };
          }
        }
        if (recordType === 'part') {
          const record = ensureRecordStructure(equipmentId);
          const item = getItem(equipmentId);
          let partId = recordId;
          if (item) {
            const exists = partId && item.partsChecklist.some(part => part.id === partId);
            if (!exists && component) {
              const match = item.partsChecklist.find(part => part.component === component);
              if (match) partId = match.id;
            }
          }
          if (partId) {
            record.parts[partId] = actualValue;
            if (updatedAt) record.partMeta[partId] = { updatedAt };
          }
        }
        if (recordType === 'note') {
          equipmentNotes[equipmentId] = {
            text: noteText || '',
            updatedAt: updatedAt || formatIsoNow()
          };
        }
      });
    }

    function updatePartActual(itemId, partId, value) {
      const record = ensureRecordStructure(itemId);
      record.parts[partId] = value;
      record.partMeta[partId] = { updatedAt: formatIsoNow() };
      saveRecords();
    }

    function toggleCheck(itemId, index) {
      const record = ensureRecordStructure(itemId);
      const idx = record.checks.indexOf(index);
      if (idx > -1) record.checks.splice(idx, 1);
      else record.checks.push(index);
      record.checkMeta[index] = { updatedAt: formatIsoNow() };
      saveRecords();
    }

    function checkAll(itemId) {
      const item = getItem(itemId);
      if (!item) return;
      const record = ensureRecordStructure(itemId);
      record.checks = item.checkItems.map((_, i) => i);
      const now = formatIsoNow();
      item.checkItems.forEach((_, i) => {
        record.checkMeta[i] = { updatedAt: now };
      });
      saveRecords();
    }

    function saveRecords() {
      localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(checkRecords));
      localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(equipmentNotes));
      updateOverallProgress();
      render();
    }

    function getLatestUpdateTimestamp() {
      let latest = null;
      const tryUpdate = value => {
        if (!value) return;
        const time = new Date(value).getTime();
        if (Number.isNaN(time)) return;
        if (!latest || time > latest) latest = time;
      };
      Object.values(checkRecords).forEach(record => {
        Object.values(record.checkMeta || {}).forEach(meta => tryUpdate(meta.updatedAt));
        Object.values(record.partMeta || {}).forEach(meta => tryUpdate(meta.updatedAt));
      });
      Object.values(equipmentNotes || {}).forEach(note => tryUpdate(note.updatedAt));
      return latest ? new Date(latest).toISOString() : '';
    }

    function updateOverallProgress() {
      let total = 0;
      let checked = 0;
      for (const tabKey in appData) {
        appData[tabKey].items.forEach(item => {
          const progress = getItemProgress(item);
          total += progress.total;
          checked += progress.done;
        });
      }
      const percent = total === 0 ? 0 : Math.round((checked / total) * 100);
      document.getElementById('global-progress').style.width = `${percent}%`;
      document.getElementById('overall-percent').innerText = `${percent}%`;
      const latest = getLatestUpdateTimestamp();
      document.getElementById('last-updated').innerText = latest ? formatTimestamp(latest) : '—';
    }

    function updateEquipmentNote(equipmentId, value) {
      equipmentNotes[equipmentId] = {
        text: value || '',
        updatedAt: formatIsoNow()
      };
      saveRecords();
    }

    function switchTab(tabKey) {
      currentTab = tabKey;
      currentDetailId = null;
      render();
    }

    function openDetail(itemId) {
      currentDetailId = itemId;
      render();
    }

    function closeDetail() {
      currentDetailId = null;
      render();
    }

    function goHome() {
      currentDetailId = null;
      currentTab = 'summary';
      render();
    }

    function renderTabNav() {
      const container = document.getElementById('tab-nav-container');
      container.innerHTML = `
        <div class="flex items-center gap-3">
          <label for="tab-select" class="text-sm font-bold text-slate-600">系統類別選取  </label>
          <div class="relative w-full max-w-xl">
            <select id="tab-select" class="w-full appearance-none bg-white border border-slate-300 text-slate-700 text-sm font-medium rounded-full px-4 py-2 pr-10 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-200"></select>
            <svg class="w-4 h-4 text-slate-400 absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.188l3.71-3.957a.75.75 0 111.08 1.04l-4.24 4.52a.75.75 0 01-1.08 0l-4.24-4.52a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
            </svg>
          </div>
        </div>`;
      const select = document.getElementById('tab-select');
      const summaryOption = new Option('總覽', 'summary');
      select.add(summaryOption);
      tabOrder.forEach(tabKey => {
        const tab = appData[tabKey];
        const option = new Option(tab.title || tabKey, tabKey);
        select.add(option);
      });
      select.value = currentTab;
      select.onchange = () => switchTab(select.value);
    }

    function updateTabNavState() {
      const select = document.getElementById('tab-select');
      if (select) select.value = currentTab;
    }

    function render() {
      const display = document.getElementById('main-display');
      display.innerHTML = '';
      updateTabNavState();
      if (currentDetailId) renderDetailPage(display);
      else if (currentTab === 'summary') renderSummaryPage(display);
      else renderListPage(display, currentTab);
    }

    function renderSummaryPage(container) {
      document.getElementById('nav-header').classList.add('hidden');
      if (!tabOrder.length) {
        container.innerHTML = '<div class="bg-white rounded-2xl border border-slate-200 p-6 text-slate-500">尚未載入分類資料。</div>';
        return;
      }
      let html = '<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">';
      tabOrder.forEach(tabKey => {
        const tab = appData[tabKey];
        let total = 0;
        let done = 0;
        tab.items.forEach(item => {
          const progress = getItemProgress(item);
          total += progress.total;
          done += progress.done;
        });
        const percent = total === 0 ? 0 : Math.round((done / total) * 100);
        const titleHtml = `<h3 class="text-lg font-bold text-slate-800">${tab.title}</h3>`;
        const descHtml = `<div class="text-xs text-slate-400">${tab.desc || ''}</div>`;
        html += `
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hover:shadow-md transition cursor-pointer" onclick="switchTab('${tabKey}')">
            ${titleHtml}
            ${descHtml}
            <div class="text-3xl font-black text-blue-600 mt-4">${percent}%</div>
            <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden mt-3">
              <div class="bg-blue-600 h-full progress-bar" style="width:${percent}%"></div>
            </div>
          </div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function renderListPage(container, tabKey) {
      const tab = appData[tabKey];
      document.getElementById('nav-header').classList.add('hidden');
      if (!tab) {
        container.innerHTML = '<div class="bg-white rounded-2xl border border-slate-200 p-6 text-slate-500">找不到這個分類。</div>';
        return;
      }
      const items = tab.items;
      let html = `
        <div class="flex items-center justify-between mb-4">
          <div class="text-sm font-bold text-slate-700">${tab.title}</div>
          <button onclick="goHome()" class="text-xs bg-slate-100 text-slate-600 px-3 py-1.5 rounded-full hover:bg-slate-200 transition">回上一層</button>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden animate-fade-in">
          <table class="w-full text-left border-collapse">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="px-4 py-4 text-xs font-bold text-slate-500 w-16 text-center">狀態</th>
                <th class="px-4 py-4 text-xs font-bold text-slate-500">設備 / 編號</th>
                <th class="px-4 py-4 text-xs font-bold text-slate-500 w-24 text-right">完成度</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">`;
      items.forEach((item, index) => {
        const progress = getItemProgress(item);
        const checked = progress.done;
        const total = progress.total;
        const isDone = total > 0 && checked === total;
        const nameHtml = `<div class="font-bold text-slate-700">${item.name}</div>`;
        const idHtml = `<div class="text-xs text-slate-400 font-mono">${item.id}</div>`;
        const hasHeater = item.basicInfo && item.basicInfo['電熱器 (kW)'];
        const hasHumidifier = item.basicInfo && item.basicInfo['加濕器 (kg/hr)'];
        html += `
              <tr onclick="openDetail('${item.id}')" class="hover:bg-blue-50 transition cursor-pointer">
                <td class="px-4 py-4 text-center">
                  <div class="status-dot ${isDone ? 'status-green' : (checked > 0 ? 'status-amber' : 'status-gray')}"></div>
                </td>
                <td class="px-4 py-4">
                  ${nameHtml}
                  ${idHtml}
                  ${item.basicInfo && (hasHeater || hasHumidifier) ? `
                    <div class="mt-1 flex gap-1">
                      ${hasHeater ? '<span class="text-[10px] bg-red-100 text-red-600 px-1 rounded font-bold">電熱器</span>' : ''}
                      ${hasHumidifier ? '<span class="text-[10px] bg-blue-100 text-blue-600 px-1 rounded font-bold">加濕器</span>' : ''}
                    </div>` : ''}
                </td>
                <td class="px-4 py-4 text-right">
                  <span class="text-xs font-mono font-bold ${isDone ? 'text-green-600' : 'text-slate-400'}">${checked} / ${total}</span>
                </td>
              </tr>`;
      });
      html += '</tbody></table>';
      html += '</div>';
      container.innerHTML = html;
    }

    function renderDetailPage(container) {
      const item = getItem(currentDetailId);
      if (!item) {
        container.innerHTML = '<div class="bg-white rounded-2xl border border-slate-200 p-6 text-slate-500">找不到設備資料。</div>';
        return;
      }
      ensureItemPartsIdentifiers(item);
      document.getElementById('nav-header').classList.remove('hidden');
      const progress = getItemProgress(item);
      const percent = progress.total === 0 ? 0 : Math.round((progress.done / progress.total) * 100);
      const record = progress.record;
      const headerName = `<h2 class="text-2xl font-black text-slate-800">${item.name}</h2>`;
      const headerId = `<div class="text-sm text-slate-400 font-mono">${item.id}</div>`;
      const noteEntry = equipmentNotes[item.id] || {};
      const noteText = escapeHtml(noteEntry.text || '');
      const noteUpdated = noteEntry.updatedAt ? formatTimestamp(noteEntry.updatedAt) : '';

      let html = `
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6 animate-fade-in">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              ${headerName}
              ${headerId}
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-400 mb-1">完成度</div>
              <div class="text-3xl font-black text-blue-600">${percent}%</div>
              <div class="text-xs text-slate-400 font-mono">${progress.done} / ${progress.total}</div>
            </div>
          </div>
          <div class="mt-4 w-full bg-slate-100 rounded-full h-2 overflow-hidden">
            <div class="bg-blue-600 h-full progress-bar" style="width:${percent}%"></div>
          </div>
        </div>`;

      const basicEntries = Object.entries(item.basicInfo || {});
      html += `
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-slate-700">設計基本資料</h3>
          </div>
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="text-xs text-slate-400">
                <th class="py-2">項目</th>
                <th class="py-2">內容</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">`;
      if (!basicEntries.length) {
        html += '<tr><td class="py-3 text-slate-400" colspan="2">尚無資料</td></tr>';
      } else {
        basicEntries.forEach(([key, value]) => {
          html += `
              <tr>
                <td class="py-3 align-top">
                  ${key}
                </td>
                <td class="py-3">
                  ${value}
                </td>
              </tr>`;
        });
      }
      html += '</tbody></table></div>';

      const parts = item.partsChecklist || [];
      html += `
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="font-bold text-slate-700">重要零件查驗數量表</h3>
              <p class="text-xs text-slate-400">輸入現場點交數量，等於設計數量視為完成。</p>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
              <thead class="text-xs text-slate-400">
                <tr>
                  <th class="py-2">零件名稱</th>
                  <th class="py-2">設計數量</th>
                  <th class="py-2">現場點交</th>
                  <th class="py-2 text-right">狀態</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">`;
      if (!parts.length) {
        html += `<tr><td class="py-3 text-slate-400" colspan="4">尚無零件資料</td></tr>`;
      } else {
        parts.forEach((part, index) => {
          const actualValue = record.parts[part.id] ?? record.parts[part.component] ?? '';
          const expected = Number(part.expected);
          const actualNumber = Number(actualValue);
          const isMatch = !Number.isNaN(expected) && !Number.isNaN(actualNumber) && expected === actualNumber;
          const meta = record.partMeta[part.id] || record.partMeta[part.component] || {};
          const updatedAtDisplay = meta.updatedAt ? formatTimestamp(meta.updatedAt) : '';
          html += `
                <tr>
                  <td class="py-3">
                    ${part.component}
                  </td>
                  <td class="py-3">
                    ${part.expected}
                  </td>
                  <td class="py-3">
                    <input class="edit-input w-24" value="${actualValue}" onchange="updatePartActual('${item.id}', '${part.id}', this.value)">
                    ${updatedAtDisplay ? `<div class="text-xs text-slate-400 mt-1">更新：${updatedAtDisplay}</div>` : ''}
                  </td>
                  <td class="py-3 text-right">
                    <span class="text-xs font-bold ${isMatch ? 'text-green-600' : 'text-slate-400'}">${isMatch ? '完成' : '未完成'}</span>
                  </td>
                </tr>`;
        });
      }
      html += '</tbody></table></div></div>';

      html += `
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
          <div class="flex items-center justify-between p-6 border-b border-slate-100">
            <h3 class="font-bold text-slate-700">功能項目查驗清單</h3>
            <div class="flex items-center gap-2">
              ${item.checkItems.length ? `<button onclick="checkAll('${item.id}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 shadow-sm">全部完成</button>` : ''}
            </div>
          </div>
          <div class="divide-y divide-slate-100">`;
      if (!item.checkItems.length) {
        html += '<div class="p-6 text-slate-400">尚無查驗項目</div>';
      } else {
        item.checkItems.forEach((text, index) => {
          const isChecked = record.checks.includes(index);
          const meta = record.checkMeta[index] || {};
          const updatedAtDisplay = meta.updatedAt ? formatTimestamp(meta.updatedAt) : '';
          const isCritical = text.includes('!!');
          const checkText = text.replace(/!!/g, '');
          html += `
              <div class="p-4 flex items-start gap-4 hover:bg-slate-50 cursor-pointer transition" onclick="toggleCheck('${item.id}', ${index})">
                <div class="pt-1">
                  <div class="w-6 h-6 rounded border-2 flex items-center justify-center transition-all ${isChecked ? 'bg-green-500 border-green-500' : 'border-slate-300'}">
                    ${isChecked ? '<svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>' : ''}
                  </div>
                </div>
                <div class="flex-grow">
                  <div class="text-base font-medium ${isChecked ? 'text-slate-400 line-through' : (isCritical ? 'text-red-600' : 'text-slate-700')}">
                    ${isCritical ? '<span class="bg-red-100 text-red-600 text-[10px] px-1.5 py-0.5 rounded font-bold mr-2">CRITICAL</span>' : ''}${checkText}
                  </div>
                  ${updatedAtDisplay ? `<div class="text-xs text-slate-400 mt-1">更新：${updatedAtDisplay}</div>` : ''}
                </div>
              </div>`;
        });
      }
      html += '</div></div>';
      html += `
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 mt-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold text-slate-700">備註</h3>
            <span class="text-xs text-slate-400">${noteUpdated ? `更新：${noteUpdated}` : '尚未更新'}</span>
          </div>
          <textarea class="w-full min-h-[120px] border border-slate-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="輸入此設備備註..." onchange="updateEquipmentNote('${item.id}', this.value)">${noteText}</textarea>
        </div>`;
      container.innerHTML = html;
    }

    window.onload = init;
  </script>
</body>

</html>
